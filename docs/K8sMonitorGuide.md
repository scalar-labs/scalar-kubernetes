# Kubernetes Monitor Guide

This document explains how to deploy Prometheus operator on Kubernetes with Ansible. After following the doc, you will be able to use Grafana, Alertmanager, and Prometheus inside Kubernetes.

## Requirements

* Have completed [How to create Azure AKS with scalar-terraform](https://github.com/scalar-labs/scalar-terraform/blob/master/docs/AKSScalarTerraformDeploymentGuide.md)
* `inventory.ini` file in `${SCALAR_K8S_CONFIG_DIR}`. Please refer to [Prepare Ansible inventory](./PrepareBastionTool.md#prepare-ansible-inventory)
* Able to communicate with the Kubernetes API from your local machine. Please refer to [How to do port-forwarding to Kubnernetes API in scalar-terraform network](./PortForwardingToK8sAPIInScalarTerraformNetwork.md).

## Deploy Prometheus

Let's deploy the Prometheus component inside Kubernetes with Ansible playbook `playbook-deploy-prometheus.yaml`.

Note that the deployment is run on the bastion host with Ansible, and the port-forwarding is not needed yet.

```console
$ cd ${SCALAR_K8S_HOME}
$ ansible-playbook -i ${SCALAR_K8S_CONFIG_DIR}/inventory.ini playbooks/playbook-deploy-prometheus.yml

PLAY [Deploy Prometheus in Kubernetes] ************************************************************************************************************************************************************************

TASK [prometheus : Create folder on remote server] ************************************************************************************************************************************************************
ok: [bastion-example-k8s-azure-by2-ot4.eastus.cloudapp.azure.com]

...

TASK [prometheus : Deploy prometheus with helm] ***************************************************************************************************************************************************************
changed: [bastion-example-k8s-azure-by2-ot4.eastus.cloudapp.azure.com]

PLAY RECAP ****************************************************************************************************************************************************************************************************
bastion-example-k8s-azure-by2-ot4.eastus.cloudapp.azure.com : ok=6    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

## How to access

Open an SSH connection to the bastion to start the port-forwarding.

```console
cd ${SCALAR_K8S_CONFIG_DIR}
ssh -F ssh.cfg bastion
```

You can have a look at Kubernetes service in the `monitoring` namespace to find the Kubernetes service name for Grafana, Prometheus and Alertmanager.

```console
$ kubectl get svc -n monitoring
NAME                                      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE
alertmanager-operated                     ClusterIP   None           <none>        9093/TCP,9094/TCP,9094/UDP   66m
prometheus-grafana                        ClusterIP   10.42.48.7     <none>        80/TCP                       66m
prometheus-kube-prometheus-alertmanager   ClusterIP   10.42.49.41    <none>        9093/TCP                     66m
prometheus-kube-prometheus-operator       ClusterIP   10.42.49.54    <none>        443/TCP                      66m
prometheus-kube-prometheus-prometheus     ClusterIP   10.42.50.204   <none>        9090/TCP                     66m
prometheus-kube-state-metrics             ClusterIP   10.42.51.231   <none>        8080/TCP                     66m
prometheus-operated                       ClusterIP   None           <none>        9090/TCP                     66m
prometheus-prometheus-node-exporter       ClusterIP   10.42.49.0     <none>        9100/TCP                     66m
```

Now let's access to Prometheus component on your local machine. Follow the 3 sections below to access to Grafana, Prometheus and Alertmanager.

### For Grafana on port 8080

```console
$ kubectl port-forward -n monitoring svc/prometheus-grafana 8080:80
Forwarding from 127.0.0.1:8080 -> 3000
Forwarding from [::1]:8080 -> 3000
```

By default, all grafana instances generated by the [kube-prometheus-stack](https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/values.yaml) chart will use `prom-operator` as the grafana admin password.

### For Alert-manager on port 9093

```console
$ kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-alertmanager 9093:9093
Forwarding from 127.0.0.1:9093 -> 9093
Forwarding from [::1]:9093 -> 9093
```

### For Prometheus on port 9090

```console
$ kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090
Forwarding from 127.0.0.1:9090 -> 9090
Forwarding from [::1]:9090 -> 9090
```
